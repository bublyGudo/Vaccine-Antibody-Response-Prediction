---
title: "Vaccine-Antibody-Response-Prediction"
author: "Fang Wang"
date: "2025-03-25"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, message = FALSE, warning = FALSE}
# LOAD LIBRARIES
library(tidyverse)
library(dplyr)
library(ggplot2)
library(pdp)
library(gt)
library(gtsummary)
library(ggpubr)
library (caret)
library(mgcv)
library(earth)
library(tidyverse)
library(rsample)

# KNIT SETTINGS
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  out.width = "90%",
  fig.align = "center"
)

# FIGURE SETTINGS
theme_set(
  theme(
    #legend.position = "bottom",
    plot.title = 
      element_text(hjust = 0.5, 
                              margin = margin(b = 5), 
                              face = "bold"),
    plot.subtitle = 
      element_text(hjust = 0.5, 
                                 margin = margin(b = 10),
                                 color = "azure4", 
                                 face = "bold", size = 8)
  )
)
```

# 1. Background & Objective

This project develops and validates a predictive model for log-transformed post-vaccination antibody levels using demographic and clinical variables.
We benchmark several model families and select a final model balancing predictive performance and interpretability, then evaluate generalizability on an independent external cohort.

# 2. Data Source & Cohort Definition

Two de-identified datasets with identical schema are provided:
• dat1: development cohort (used for training + internal test)
• dat2: independent cohort for external validation

Outcome: log_antibody
Key predictors include demographics (age, sex, race/ethnicity), comorbidities (diabetes, hypertension), clinical measures (BMI, SBP, LDL), and time since vaccination (time).


```{r}
# =========================
# 2) Load Data
# =========================

load("data/dat1.RData")
load("data/dat2.RData")

dat1 = as_tibble(dat1) |> 
  janitor::clean_names() |> 
  mutate(across(c(gender, race, smoking, hypertension, diabetes), as.factor))

dat2 = as_tibble(dat2) |> 
  janitor::clean_names() |> 
  mutate(across(c(gender, race, smoking, hypertension, diabetes), as.factor))

dat1_decoded = dat1 |> 
  mutate(
    across(c(gender, race, smoking, hypertension, diabetes), as.character),
    across(c(gender, race, smoking, hypertension, diabetes), as.numeric),
    gender = factor(
      case_match(gender, 0 ~ "Female", 1 ~ "Male"), 
      levels = c("Female", "Male")),
    race = factor(
      case_match(race, 1 ~ "White", 2 ~ "Asian", 3 ~ "Black", 4 ~ "Hispanic"), 
      levels = c("White", "Asian", "Black", "Hispanic")),
    smoking = factor(
      case_match(smoking, 
                 0 ~ "Never smoked", 
                 1 ~ "Former smoker", 
                 2 ~ "Current smoker"), 
      levels = c("Never smoked", "Former smoker", "Current smoker")),
    hypertension = factor(
      case_match(hypertension, 0 ~ "No", 1 ~ "Yes"), 
      levels = c("No", "Yes")),
    diabetes = factor(
      case_match(diabetes, 0 ~ "No", 1 ~ "Yes"), 
      levels = c("No", "Yes"))
  )

head(dat1_decoded, 5) |> 
  knitr::kable(digits = 2)
```

# 3. Cohort Characteristics & Clinically Relevant EDA
3.1 Cohort characteristics (dat1)
```{r message = FALSE}
dat1_decoded |> 
  select(-id) |> 
  tbl_summary(
    statistic = list (all_continuous() ~ "{min} - {max} | Mean: {mean} (SD: {sd})", 
                      all_categorical() ~ "{n} ({p}%)"),
    label = list(
      id = "ID (id)",
      age = "Age (age) ",
      gender = "Gender (gender)",
      race = "Race/ethnicity (race)",
      smoking = "Smoking (smoking)",
      height = "Height (height)",
      weight = "Weight (weight)",
      bmi = "BMI (bmi)",
      diabetes = "Diabetes (diabetes)",
      hypertension = "Hypertension (hypertension)",
      sbp = "Systolic blood pressure (sbp)",
      ldl = "LDL cholesterol (ldl)",
      time = "Time since vaccination (time)",
      log_antibody = "Log-transformed antibody level (log_antibody)"
    )
  ) |> 
  modify_caption("**Summary Statistics for Dataset 1**")
```

3.2 EDA (dat1)
```{r}
## Categorical Variable Barplots

p_gender = ggplot(dat1_decoded, aes(x = gender)) + 
  geom_bar(fill = "skyblue", color = "black", lwd = 0.5) + 
  labs(title = "Gender\nDistribution", x = "Gender", y = "Count")

p_race = ggplot(dat1_decoded, aes(x = race)) + 
  geom_bar(fill= "orange", color = "black", lwd = 0.5) + 
  labs(title = "Race/Ethnicity\nDistribution", 
       x = "Race/Ethnicity", 
       y = "Count")

p_smoking = dat1_decoded |> 
  mutate(smoking = fct_rev(as.factor(str_replace(smoking, " ", "\n")))) |> 
  ggplot(aes(x = smoking)) + 
  geom_bar(fill = "skyblue", color = "black", lwd = 0.5) + 
  labs(title = "Smoking Status\nDistribution", 
       x = "Smoking", 
       y = "Count")

p_diabetes = ggplot(dat1_decoded, aes(x = diabetes)) + 
  geom_bar(fill = "orange", color = "black", lwd = 0.5) + 
  labs(title = "Diabetes Status\nDistribution", 
       x = "Diabetes", 
       y = "Count")

p_hypertension = ggplot(dat1_decoded, aes(x = hypertension)) + 
  geom_bar(fill = "skyblue", color = "black", lwd = 0.5) + 
  labs(title = "Hypertension Status\nDistribution", 
       x = "Hypertension", 
       y = "Count")

barplot_combined = ggarrange(p_gender, 
                             p_race, 
                             p_smoking, 
                             p_diabetes, 
                             p_hypertension, 
                             nrow = 2, 
                             ncol = 3)

barplot_combined
```

```{r}
## Numeric Variable Histograms

p_age = ggplot(dat1_decoded, aes(x = age)) + 
  geom_histogram(fill = "skyblue", color = "black", lwd = 0.5) + 
  labs(title = "Age\nDistribution", 
       x = "Age", 
       y = "Count")

p_height = ggplot(dat1_decoded, aes(x = height)) + 
  geom_histogram(fill = "orange", color = "black", lwd = 0.5) + 
  labs(title = "Height\nDistribution", 
       x = "Height", 
       y = "Count")

p_weight = ggplot(dat1_decoded, aes(x = weight)) + 
  geom_histogram(fill = "skyblue", color = "black", lwd = 0.5) + 
  labs(title = "Weight\nDistribution", 
       x = "Weight", 
       y = "Count")

p_bmi = ggplot(dat1_decoded, aes(x = bmi)) + 
  geom_histogram(fill = "orange", color = "black", lwd = 0.5) + 
  labs(title = "Body Mass Index\nDistribution", 
       x = "BMI", 
       y = "Count")

p_sbp = ggplot(dat1_decoded, aes(x = sbp)) + 
  geom_histogram(fill = "skyblue", color = "black", lwd = 0.5) + 
  labs(title = "Systolic Blood Pressure\nDistribution", 
       x = "Systolic Blood Pressure", 
       y = "Count")

p_ldl = ggplot(dat1_decoded, aes(x = ldl)) + 
  geom_histogram(fill = "orange", color = "black", lwd = 0.5) + 
  labs(title = "LDL Cholesterol\nDistribution", 
       x = "LDL Cholesterol", 
       y = "Count")

p_time = ggplot(dat1_decoded, aes(x = time)) + 
  geom_histogram(fill = "skyblue", color = "black", lwd = 0.5) + 
  labs(title = "Time Since Vax\nDistribution", 
       x = "Time Since Vaccination", 
       y = "Count")

histogram_combined = ggarrange(p_age, 
                               p_height, 
                               p_weight, 
                               p_bmi, 
                               p_sbp, 
                               p_ldl, 
                               p_time, 
                               nrow = 3, 
                               ncol = 3)

histogram_combined
```

# 4. Model Development Preprocessing
• Split dat1 into training (80%) and internal test (20%) using a fixed seed.
• Bivariate Plots before model training

```{r split}
# =========================
# 4) Train/Test Split + CV control
# =========================

# split dataset into training data and testing data:
set.seed(2025)
data_split = initial_split(dat1, prop =0.8)
training_data = training (data_split)
testing_data = testing (data_split)
# Cross-validation setup:
ctrl1 = trainControl(method = "cv", number = 10)
```


```{r}
# =========================
# 4.1 Bivariate Plots: Density Plots of Response Variable by Categorical Variables
# =========================

# Create function for plot generation
cat_plot = function(var, label, df = dat1_decoded){
  output_plot = df |> 
    ggplot(aes(x = log_antibody, fill = !!sym(var))) +
    geom_density(alpha = 0.5, lwd = 0.5) +
    labs(
      title = paste0("Log Antibody vs. ", label),
      x = "Log Antibody",
      y = "Density",
      fill = label
    )
  
  return(output_plot)
}

training_data_decoded = dat1_decoded |> 
  filter(id %in% training_data$id)

# Generate Plots
gender_plot = cat_plot("gender", 
                       "Gender", 
                       training_data_decoded)
race_plot = cat_plot("race", 
                     "Race", 
                     training_data_decoded)
smoking_plot = cat_plot("smoking", 
                        "Smoking Status", 
                        training_data_decoded)
hypertension_plot = cat_plot("hypertension", 
                             "Hypertension", 
                             training_data_decoded)
diabetes_plot = cat_plot("diabetes", 
                         "Diabetes", 
                         training_data_decoded)

# Display multi-plot figure (manually exporting to save multi-plot figure)
cat_vars_plot = ggarrange(gender_plot, 
                          race_plot, 
                          smoking_plot, 
                          hypertension_plot, 
                          diabetes_plot, 
                          nrow = 3, 
                          ncol = 2)
cat_vars_plot
```


```{r}
# =========================
# 4.2 Bivariate Plots: Scatterplots for Response with Numeric Variables
# =========================

# Create function for plot generation
num_plot = function(var, label, xlab, df = dat1){
  output_plot = df |> 
    ggplot(aes(x = !!sym(var), y = log_antibody)) +
    geom_point(size = 0.3) +
    geom_smooth(lwd = 0.5, method = "loess", color = "red") +
    labs(
      title = paste0("Log Antibody vs. ", label),
      x = xlab,
      y = "Log Antibody"
    )
  
  return(output_plot)
}

# Generate Plots
age_plot = num_plot("age", "Age", "Age (years)", training_data)
height_plot = num_plot("height", "Height", "Height", training_data)
weight_plot = num_plot("weight", "Weight", "Weight", training_data)
bmi_plot = num_plot("bmi", "BMI", "Body Mass Index", training_data)
sbp_plot = num_plot("sbp", "SBP", "Systolic Blood Pressure", training_data)
ldl_plot = num_plot("ldl", "LDL", "LDL Cholesterol", training_data)
time_plot = num_plot("time", "Time", "Time Since Vaccination", training_data)

# Display multi-plot figure (manually exporting to save multi-plot figure)
cont_vars_plot = ggarrange(age_plot, 
                           height_plot, 
                           weight_plot, 
                           bmi_plot, 
                           sbp_plot, 
                           ldl_plot, 
                           time_plot, 
                           nrow = 3, 
                           ncol= 3)
cont_vars_plot
```


```{r}
# =========================
# 4.3 Correlation Plot
# =========================
dat1_x_matrix = model.matrix(log_antibody ~ ., data = dat1)[, -1]
corrplot::corrplot(cor(dat1_x_matrix), method = "circle", type = "full")
```
The correlation matrix indicates that the majority of predictors are only weakly correlated. Strong positive correlations are observed between weight and BMI, and moderate correlations between height and weight, reflecting expected anthropometric relationships.
Among cardiometabolic variables, systolic blood pressure (SBP) is positively correlated with hypertension status, and modest correlations are also seen between SBP and LDL cholesterol.

Importantly, no pair of predictors demonstrates extremely high correlation, suggesting that multicollinearity is unlikely to substantially bias model estimation.

# 5. Model Development
• Benchmark model families with 10-fold cross-validation:
   #Linear regression (OLS)
   #Elastic Net (glmnet)
   #Partial Least Squares (PLS)
   #Generalized Additive Model (GAM)
MARS (earth)
• Primary metric: RMSE; secondary: MAE and R².

5.1 Create model matrix (for algorithms that require x/y)
```{r matrix}
# training_data
x = model.matrix(log_antibody~ .- id, training_data)[,-1]
y = training_data$log_antibody
```

5.2 Candidate models
```{r}
set.seed(2025)

# 1) OLS 
lm_fit = train(
  x = x, 
  y = y,
  method = "lm",
  trControl = ctrl1
)

# 2) Elastic Net
enet_fit = train(
    x = x,
    y = y,
    method = "glmnet",
    tuneGrid = expand.grid(
        alpha = seq(0, 1, length = 21),
        lambda = exp(seq(9, -3, length = 100))
    ),
    trControl = ctrl1
)


# 3) PLS
pls_fit = train(x, y,
  method = "pls",
  tuneGrid = data.frame(ncomp = 1:14),
  trControl = ctrl1,
  preProcess = c("center", "scale"))

# 4) GAM (formula-based for interpretability)
gam_fit = train(
  log_antibody ~ age + height + weight + bmi + sbp + ldl + time + gender + race + smoking + diabetes + hypertension,
  data = training_data,
  method = "gam",
  trControl = ctrl1
)

# 5) MARS

mars_grid = expand.grid(degree = 1:4, nprune = 2:20)
mars_fit = train(x, y,
                  method = "earth",
                  tuneGrid = mars_grid,
                  trControl = ctrl1)
```

5.3 Benchmark results (CV)
```{r}
resamp = resamples(list(OLS = lm_fit,
                        ENET = enet_fit,
                        PLS = pls_fit,
                        GAM = gam_fit, 
                        MARS = mars_fit))
summary(resamp)

bwplot(resamp, metric = "RMSE")

png("figures/model_comparison.png", width = 1400, height = 800, res = 200)
```

# 6. Final Model Selection & Interpretability

We select the model with best cross-validated RMSE while maintaining interpretability.
In this analysis, GAM provides strong performance and interpretable non-linear effects.

```{r}
plot(gam_fit$finalModel, pages = 1, shade = TRUE, seWithMean = TRUE)

# If you want to save this plot:

png("figures/gam_smooth_terms.png", width = 1400, height = 800, res = 200)
plot(gam_fit$finalModel, pages = 1, shade = TRUE, seWithMean = TRUE)
dev.off()
```

# 7. Internal Test Performance (dat1 hold-out)
```{r}
final_model <- gam_fit
pred_test <- predict(final_model, newdata = testing_data)

rmse_internal <- sqrt(mean((pred_test - testing_data$log_antibody)^2))
mae_internal  <- mean(abs(pred_test - testing_data$log_antibody))

rmse_internal
mae_internal

# Pred vs Observed plot (internal)

p_int <- tibble(
observed = testing_data$log_antibody,
predicted = pred_test
) |>
ggplot(aes(x = observed, y = predicted)) +
geom_point(alpha = 0.35, size = 0.7) +
geom_abline(slope = 1, intercept = 0, lwd = 0.7) +
labs(
title = "Internal Test: Predicted vs Observed (dat1 test)",
x = "Observed log antibody",
y = "Predicted log antibody"
)

p_int
ggsave("figures/pred_vs_obs_internal.png", p_int, width = 6.5, height = 4, dpi = 300)
```

The model shows good agreement between predicted and observed antibody levels in the internal test set, with most predictions closely aligned to the 45-degree reference line.

# 8. External Validation (independent cohort: dat2)
```{r}
pred_ext <- predict(final_model, newdata = dat2)

rmse_external <- sqrt(mean((pred_ext - dat2$log_antibody)^2))
mae_external  <- mean(abs(pred_ext - dat2$log_antibody))

rmse_external
mae_external

# Pred vs Observed plot (external)

p_ext <- tibble(
observed = dat2$log_antibody,
predicted = pred_ext
) |>
ggplot(aes(x = observed, y = predicted)) +
geom_point(alpha = 0.35, size = 0.7) +
geom_abline(slope = 1, intercept = 0, lwd = 0.7) +
labs(
title = "External Validation: Predicted vs Observed (dat2)",
x = "Observed log antibody",
y = "Predicted log antibody"
)

p_ext
ggsave("figures/pred_vs_obs_external.png", p_ext, width = 6.5, height = 4, dpi = 300)
```

While prediction accuracy decreases modestly in the external cohort, the model retains a clear linear association between predicted and observed values, indicating reasonable transportability.

# 9. Conclusion

Predicted-versus-observed plots demonstrate good calibration in the internal test set, with predictions closely aligned to the identity line.
In external validation, prediction uncertainty increases and mild underestimation is observed at higher antibody levels, consistent with expected cohort shift.
Importantly, the overall linear association is preserved, indicating reasonable generalizability of the model beyond the development cohort.

# 10. Limitations & Next Steps
•This is an observational modeling exercise; associations do not imply causation.
•Potential cohort shift between dat1 and dat2 may affect transportability.
•Next steps could include calibration assessment, feature engineering, and sensitivity analyses.
